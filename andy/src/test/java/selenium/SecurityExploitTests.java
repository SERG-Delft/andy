package selenium;

import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.CsvSource;
import selenium.pageobjects.WebLabSubmissionPage;

import java.io.IOException;

import static org.assertj.core.api.Assertions.assertThat;
import static unit.writer.standard.StandardResultTestAssertions.*;

public class SecurityExploitTests extends WebLabSeleniumTestBase {

    private static final String ASSIGNMENT_PRACTICE = "89104";

    @ParameterizedTest
    @CsvSource({
            "WriteResultsXml,name=results.xml actions=write",
            "SystemExit,name=exitVM.",
            "SetProperty,test actions=write",
            "RuntimeExec,actions=execute",
            "ReadSource,ExploitTest.java actions=read",
            "ReadClass,ExploitTest$1.class actions=read"
    })
    public void testExploitPracticeSubmission(String exploitFile, String expectedMessage) throws IOException {
        String testSubmissionContent = readSubmissionFile("/grader/fixtures/Solution/securitytests/",
                exploitFile + ".java");

        WebLabSubmissionPage webLabSubmissionPage = new WebLabSubmissionPage(driver,
                WEBLAB_URL + String.format(WEBLAB_SUBMISSION_PATH, ASSIGNMENT_PRACTICE, USER_ID));

        webLabSubmissionPage.navigate();
        webLabSubmissionPage.enterSolution(testSubmissionContent);
        webLabSubmissionPage.assessWithHints();

        String output = webLabSubmissionPage.getOutput();

        assertThat(output)
                .has(compilationSuccess())
                .has(numberOfJUnitTestsPassing(0))
                .contains(SecurityException.class.getName() + ": Operation not permitted")
                .contains(expectedMessage)
                .has(finalGrade(0))
                .contains("Test score: 0/100");
    }

    @ParameterizedTest
    @CsvSource({
            "OtherPackageName,package name of your solution",
            "InstantiateConfiguration,Accessing the task configuration",
            "UseReflection,Using reflection"
    })
    public void testFailingSecurityCheckPracticeSubmission(String exploitFile, String expectedMessage) throws IOException {
        String testSubmissionContent = readSubmissionFile("/grader/fixtures/Solution/securitytests/",
                exploitFile + ".java");

        WebLabSubmissionPage webLabSubmissionPage = new WebLabSubmissionPage(driver,
                WEBLAB_URL + String.format(WEBLAB_SUBMISSION_PATH, ASSIGNMENT_PRACTICE, USER_ID));

        webLabSubmissionPage.navigate();
        webLabSubmissionPage.enterSolution(testSubmissionContent);
        webLabSubmissionPage.assessWithHints();

        String output = webLabSubmissionPage.getOutput();

        assertThat(output)
                .has(compilationFailure())
                .contains(expectedMessage)
                .has(noFinalGrade())
                .contains("Test score: 0/100");
    }

}
