package selenium;

import org.junit.jupiter.api.Tag;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.CsvSource;
import selenium.pageobjects.WebLabSubmissionPage;

import java.io.IOException;

import static org.assertj.core.api.Assertions.assertThat;
import static unit.writer.standard.StandardResultTestAssertions.*;

@Tag("weblab")
public class SecurityExploitTests extends WebLabSeleniumTestBase {

    private static final String ASSIGNMENT_PRACTICE = "89104";

    @ParameterizedTest
    @CsvSource({
            "OtherPackageName,package name of your solution",
            "InstantiateConfiguration,Accessing the task configuration",
            "UseReflection,Using reflection"
    })
    public void testFailingSecurityCheckPracticeSubmission(String exploitFile, String expectedMessage) throws IOException {
        String testSubmissionContent = readSubmissionFile("/grader/fixtures/Solution/securitytests/",
                exploitFile + ".java");

        WebLabSubmissionPage webLabSubmissionPage = new WebLabSubmissionPage(driver,
                WEBLAB_URL + String.format(WEBLAB_SUBMISSION_PATH, ASSIGNMENT_PRACTICE, USER_ID));

        webLabSubmissionPage.navigate();
        webLabSubmissionPage.enterSolution(testSubmissionContent);
        webLabSubmissionPage.assessWithHints();

        String output = webLabSubmissionPage.getOutput();

        assertThat(output)
                .has(compilationFailure())
                .contains(expectedMessage)
                .has(noFinalGrade())
                .contains("Test score: 0/100");
    }

}
